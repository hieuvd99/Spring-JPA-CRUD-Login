name: CI/CD to Dev Server

on:
  push:
    branches:
      - master

jobs:
  build-and-run:
    runs-on: self-hosted
    name: Build and Run on Dev Server

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Show workspace
      run: echo "GITHUB_WORKSPACE is:$GITHUB_WORKSPACE"

    - name: Run Unit Tests
      run: mvn test

    - name: Run SpotBugs
      run: mvn spotbugs:spotbugs  

    - name: Build project
      run: mvn -B clean package -DskipTests

    - name: Restart Spring Boot App
      run: sudo systemctl restart myapp

    - name: Get PR info
      id: pr_info
      run: |
        MERGE_COMMIT_SHA=$(git rev-parse HEAD)
        echo "Merge commit: $MERGE_COMMIT_SHA"

        PR_JSON=$(curl -s \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/commits/$MERGE_COMMIT_SHA/pulls)

        PR_TITLE=$(echo $PR_JSON | jq -r '.[0].title // "N/A"')
        PR_AUTHOR=$(echo $PR_JSON | jq -r '.[0].user.login // "N/A"')
        PR_LINK=$(echo $PR_JSON | jq -r '.[0].html_url // "N/A"')
        PR_BRANCH=$(echo $PR_JSON | jq -r '.[0].head.ref // "N/A"')

        echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
        echo "PR_AUTHOR=$PR_AUTHOR" >> $GITHUB_ENV
        echo "PR_LINK=$PR_LINK" >> $GITHUB_ENV
        echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV

    - name: Notify Telegram Success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ✅ Deployment successful
          PR: ${{ env.PR_TITLE }}
          Branch: ${{ env.PR_BRANCH }}
          PR Link: ${{ env.PR_LINK }}
          Author: ${{ env.PR_AUTHOR }}

    - name: Notify Telegram Failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ❌ Deployment failed
          PR: ${{ env.PR_TITLE }}
          Branch: ${{ env.PR_BRANCH }}
          PR Link: ${{ env.PR_LINK }}
          Author: ${{ env.PR_AUTHOR }}
